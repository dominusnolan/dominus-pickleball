# Dominus Pickleball Booking Plugin

A WordPress plugin for booking pickleball courts with WooCommerce integration and authentication features.

## Features

- **Court Booking System**: Select time slots for multiple courts and dates
- **WooCommerce Integration**: Seamless checkout process with booking metadata
- **Authentication**: Native WordPress/WooCommerce login and registration
- **Google OAuth**: Sign in with Google account (One Tap and button)
- **Mobile-Friendly**: Responsive design with list and grid views
- **Admin Settings**: Configure courts, times, pricing, blocked times, and holidays

## Requirements

- WordPress 5.0 or higher
- WooCommerce plugin
- PHP 7.4 or higher

## Installation

1. Upload the plugin files to `/wp-content/plugins/dominus-pickleball/`
2. Activate the plugin through the 'Plugins' menu in WordPress
3. Configure settings under 'Pickleball' in the admin menu
4. Add the booking form to any page using the shortcode: `[dp_booking_form]`

## Google OAuth Setup

To enable "Sign in with Google" functionality:

### 1. Create a Google Cloud Project

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select an existing one
3. Enable the **Google+ API** or **Google Identity Services**

### 2. Create OAuth 2.0 Credentials

1. Navigate to **APIs & Services** > **Credentials**
2. Click **Create Credentials** > **OAuth client ID**
3. Select **Web application** as the application type
4. Configure the OAuth consent screen if prompted
5. Add **Authorized JavaScript origins**:
   - `https://yourdomain.com`
   - `http://yourdomain.com` (for testing only)
6. Add **Authorized redirect URIs** (optional for client-side flow):
   - `https://yourdomain.com`
7. Click **Create** and copy the **Client ID**

### 3. Configure the Plugin

You can configure the Google Client ID in two ways:

#### Option A: WordPress Admin Settings (Recommended for ease)

1. Go to **Pickleball** > **Settings** in WordPress admin
2. Find the **Google Client ID** field under General Settings
3. Paste your Client ID
4. Click **Save Settings**

#### Option B: wp-config.php (Recommended for security)

Add this line to your `wp-config.php` file:

```php
define( 'DP_GOOGLE_CLIENT_ID', 'YOUR-CLIENT-ID.apps.googleusercontent.com' );
```

### 4. Verify Domain Ownership

Make sure your domain is added to the **Authorized domains** list in the OAuth consent screen settings.

## Configuration Options

### General Settings

- **Number of Courts**: Set how many courts are available
- **Opening Time**: When the facility opens
- **Closing Time**: When the facility closes  
- **Price per Slot**: Cost for a 60-minute booking
- **Google Client ID**: For Google OAuth sign-in

### Blocked Time Ranges

Set times when courts are unavailable (e.g., maintenance, private events):
- Configure general blocked times for all courts
- Or set court-specific blocked times per day of week

### Holidays

- **Full-Day Holidays**: Dates when facility is completely closed (format: YYYY-MM-DD, one per line)
- **Partial-Day Holidays**: Specific time ranges unavailable (format: YYYY-MM-DD HH:MM-HH:MM, one per line)

## Usage

### For Site Visitors

1. Navigate to the booking page
2. Select a date from the calendar
3. Click on available time slots to select them
4. Multiple slots can be selected
5. Click "Login to Book" if not logged in
6. Login with:
   - Email/username and password
   - Or continue with Google
7. Or register a new account
8. Once logged in, click "Book Now" to proceed to checkout

### Login/Registration Modal

The enhanced login modal provides:

- **Login Tab**:
  - Email/Username field
  - Password field
  - Remember me checkbox
  - Forgot password link
  - Continue with Google button

- **Register Tab**:
  - Email address field
  - Password field (if not auto-generated by WooCommerce)
  - Terms acceptance checkbox (if enabled)
  - Continue with Google button

## Testing Guide

### Manual Test Plan

#### 1. Login Flow

**Test Case**: Login with WooCommerce account
- **Steps**:
  1. Navigate to booking page
  2. Click "Login to Book"
  3. Switch to "Log in" tab
  4. Enter valid username/email and password
  5. Check "Remember me" (optional)
  6. Click "Log In"
- **Expected**: User logged in successfully, modal closes, page updates to show logged-in state

**Test Case**: Login with incorrect credentials
- **Steps**:
  1. Click "Login to Book"
  2. Enter incorrect username/password
  3. Click "Log In"
- **Expected**: Error message displayed, user remains on login form

**Test Case**: Forgot password link
- **Steps**:
  1. Click "Login to Book"
  2. Click "Forgot password?" link
- **Expected**: Redirects to WordPress password reset page

#### 2. Registration Flow

**Test Case**: Register new account
- **Steps**:
  1. Click "Login to Book"
  2. Switch to "Register" tab
  3. Enter valid email address
  4. Enter password (if required)
  5. Accept terms (if shown)
  6. Click "Create Account"
- **Expected**: Account created, user auto-logged in, modal closes

**Test Case**: Register with existing email
- **Steps**:
  1. Click "Login to Book"
  2. Switch to "Register" tab
  3. Enter email of existing account
  4. Click "Create Account"
- **Expected**: Error message: "An account with this email already exists. Please login instead."

**Test Case**: Register without accepting terms
- **Steps**:
  1. Click "Login to Book"
  2. Switch to "Register" tab
  3. Enter email and password
  4. Leave terms checkbox unchecked
  5. Click "Create Account"
- **Expected**: Error message about terms acceptance

#### 3. Google OAuth Flow

**Test Case**: First-time Google sign-in (new user)
- **Steps**:
  1. Click "Login to Book"
  2. Click "Continue with Google"
  3. Select Google account
  4. Authorize the application
- **Expected**: New WordPress account created with Google email, user auto-logged in, modal closes

**Test Case**: Repeat Google sign-in (existing user)
- **Steps**:
  1. Logout
  2. Click "Login to Book"
  3. Click "Continue with Google"
  4. Select same Google account
- **Expected**: User logged in immediately, modal closes

**Test Case**: Google sign-in with existing email (linking)
- **Steps**:
  1. Have an existing WooCommerce account with email user@example.com
  2. Click "Login to Book"
  3. Click "Continue with Google"
  4. Sign in with Google account using user@example.com
- **Expected**: Google account linked to existing WordPress account, user logged in

**Test Case**: Google sign-in cancelled
- **Steps**:
  1. Click "Continue with Google"
  2. Close Google popup or click "Cancel"
- **Expected**: Modal remains open, no error shown

#### 4. Error Conditions

**Test Case**: Network error during login
- **Steps**:
  1. Disconnect from internet
  2. Try to login
- **Expected**: Error message: "Network error. Please try again."

**Test Case**: Empty fields validation
- **Steps**:
  1. Click "Login to Book"
  2. Leave all fields empty
  3. Click "Log In"
- **Expected**: Error message about required fields

**Test Case**: Invalid email format
- **Steps**:
  1. Switch to "Register" tab
  2. Enter "notanemail" in email field
  3. Click "Create Account"
- **Expected**: Browser validation or error message about invalid email

#### 5. Modal Behavior

**Test Case**: Close modal with X button
- **Steps**:
  1. Click "Login to Book"
  2. Click the X close button
- **Expected**: Modal closes, form resets to login tab

**Test Case**: Close modal with Escape key
- **Steps**:
  1. Click "Login to Book"
  2. Press Escape key
- **Expected**: Modal closes

**Test Case**: Close modal by clicking outside
- **Steps**:
  1. Click "Login to Book"
  2. Click on the dark overlay outside modal
- **Expected**: Modal closes

**Test Case**: Tab switching
- **Steps**:
  1. Click "Login to Book"
  2. Click "Register" tab
  3. Click "Log in" tab
- **Expected**: Tabs switch smoothly, forms reset, no errors persist

#### 6. Integration with Booking

**Test Case**: Complete booking after login
- **Steps**:
  1. Select time slots (not logged in)
  2. Click "Login to Book"
  3. Login successfully
  4. Click "Book Now"
- **Expected**: Selected slots preserved, redirects to checkout

**Test Case**: Complete booking after registration
- **Steps**:
  1. Select time slots
  2. Register new account via modal
  3. Click "Book Now"
- **Expected**: Selected slots preserved, redirects to checkout

#### 7. WooCommerce Settings Compatibility

**Test Case**: Auto-generate password enabled
- **Steps**:
  1. In WooCommerce > Settings > Accounts, enable "Auto-generate passwords"
  2. Open registration modal
- **Expected**: Password field not shown in registration form

**Test Case**: Registration disabled
- **Steps**:
  1. In WooCommerce > Settings > Accounts, disable "Allow customers to create an account"
  2. Try to access register tab
- **Expected**: Registration form shows error or tab is disabled

### Automated Testing

If your repository has a testing framework:

```bash
# Run PHP unit tests (if available)
vendor/bin/phpunit

# Run JavaScript tests (if available)
npm test
```

## Security Features

- **CSRF Protection**: All AJAX endpoints use WordPress nonces
- **Input Sanitization**: All user input is sanitized and validated
- **Google Token Verification**: ID tokens are verified with Google's API
- **Password Hashing**: WordPress handles password hashing securely
- **SQL Injection Prevention**: All database queries use prepared statements

## Filters and Hooks

### Filters

- `dp_require_terms_acceptance` - Whether to show/require terms checkbox (default: false)
- `dp_login_redirect_url` - URL to redirect after login (default: current page)
- `dp_register_redirect_url` - URL to redirect after registration (default: current page)
- `dp_google_signin_redirect_url` - URL to redirect after Google sign-in (default: current page)

Example:
```php
// Require terms acceptance
add_filter( 'dp_require_terms_acceptance', '__return_true' );

// Redirect to custom page after login
add_filter( 'dp_login_redirect_url', function() {
    return home_url( '/my-bookings/' );
});
```

## Troubleshooting

### Google Sign-In Not Working

1. **Verify Client ID**: Make sure it's correctly configured
2. **Check Authorized Origins**: Your domain must be in the authorized list
3. **Check Browser Console**: Look for JavaScript errors
4. **Verify Domain**: Domain must be verified in Google Cloud Console
5. **Check SSL**: Google OAuth requires HTTPS in production

### Login/Registration Errors

1. **Check WooCommerce Settings**: Registration must be enabled
2. **Check User Role**: Ensure "customer" role exists
3. **Email Verification**: Some WooCommerce setups require email verification
4. **Check Error Logs**: Look in WordPress debug.log for PHP errors

### Modal Not Appearing

1. **Check JavaScript**: Look for console errors
2. **Verify Shortcode**: Make sure booking form shortcode is on the page
3. **Clear Cache**: Clear browser and server cache
4. **Check Enqueued Scripts**: Verify dp-modal-auth.js is loaded

## Support

For issues, questions, or contributions:
- GitHub: [dominusnolan/dominus-pickleball](https://github.com/dominusnolan/dominus-pickleball)
- Email: info@dominusit.online

## License

GPL-2.0+

## Changelog

### Version 1.0.0
- Initial release with booking system
- WooCommerce integration
- Native login/registration
- Google OAuth integration
- Mobile-responsive design
- Admin settings panel
